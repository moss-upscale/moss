name: build
on:
  push:
    branches:
      - master
      - devs/*
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: moss-${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  config:
    runs-on: ubuntu-latest
    outputs:
      opencv_version: ${{ steps.cfg.outputs.opencv_version }}
      build_list: ${{ steps.cfg.outputs.build_list }}
      shared: ${{ steps.cfg.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: true
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Read OpenCV config
        id: cfg
        run: |
          python3 .github/tools/opencv_ci.py read-config \
            --config ".github/opencv-config.json" \
            --github-output "$GITHUB_OUTPUT"

  opencv-ubuntu:
    needs: config
    uses: ./.github/workflows/build-opencv.yml
    with:
      runner: ubuntu-22.04
      opencv_version: ${{ needs.config.outputs.opencv_version }}
      build_list: ${{ needs.config.outputs.build_list }}
      shared: ${{ needs.config.outputs.shared }}

  opencv-windows:
    needs: config
    uses: ./.github/workflows/build-opencv.yml
    with:
      runner: windows-latest
      opencv_version: ${{ needs.config.outputs.opencv_version }}
      build_list: ${{ needs.config.outputs.build_list }}
      shared: ${{ needs.config.outputs.shared }}

  opencv-macos:
    needs: config
    uses: ./.github/workflows/build-opencv.yml
    with:
      runner: macos-latest
      opencv_version: ${{ needs.config.outputs.opencv_version }}
      build_list: ${{ needs.config.outputs.build_list }}
      shared: ${{ needs.config.outputs.shared }}

  opencv-macos-intel:
    needs: config
    uses: ./.github/workflows/build-opencv.yml
    with:
      runner: macos-15-intel
      opencv_version: ${{ needs.config.outputs.opencv_version }}
      build_list: ${{ needs.config.outputs.build_list }}
      shared: ${{ needs.config.outputs.shared }}

  tauri-build:
    name: Tauri Build (${{ matrix.platform }})
    permissions:
      contents: write
    needs: [ config, opencv-ubuntu, opencv-windows, opencv-macos, opencv-macos-intel ]
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-15-intel'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: '--bundles deb'
          - platform: 'windows-latest'
            args: ''
    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        shell: bash
    env:
      RUST_BACKTRACE: 1
      CARGO_INCREMENTAL: 0
      CARGO_TERM_COLOR: always
      OPENCV_MODULES_HASH: ${{ (matrix.platform == 'macos-latest' && needs.opencv-macos.outputs.modules_hash) || (matrix.platform == 'macos-15-intel' && needs.opencv-macos-intel.outputs.modules_hash) || (matrix.platform == 'ubuntu-22.04' && needs.opencv-ubuntu.outputs.modules_hash) || needs.opencv-windows.outputs.modules_hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: true
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install Ubuntu dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt update
          sudo apt install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
          sudo apt install -y libavif-dev
      - name: Install LLVM/Clang
        if: matrix.platform == 'ubuntu-22.04'
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: '19'
      - name: Set macOS linker env
        if: matrix.platform == 'macos-latest' || matrix.platform == 'macos-15-intel'
        run: |
          brew install llvm
          brew install libavif
          echo "CLANG_PATH=$(brew --prefix llvm)/bin/clang" >> $GITHUB_ENV
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV
          echo "DYLD_FALLBACK_LIBRARY_PATH=$(brew --prefix llvm)/lib" >> $GITHUB_ENV
          echo "CC=$(brew --prefix llvm)/bin/clang" >> $GITHUB_ENV
          echo "CXX=$(brew --prefix llvm)/bin/clang++" >> $GITHUB_ENV
          echo "SDKROOT=$(xcrun --sdk macosx --show-sdk-path)" >> $GITHUB_ENV
      - name: Download OpenCV Artifact
        uses: actions/download-artifact@v4
        with:
          name: opencv-${{ matrix.platform }}-${{ needs.config.outputs.opencv_version }}-${{ env.OPENCV_MODULES_HASH }}
          path: ${{ github.workspace }}/.opencv/${{ needs.config.outputs.opencv_version }}/${{ env.OPENCV_MODULES_HASH }}
      - name: Export OpenCV Env
        id: export
        run: |
          python3 .github/tools/opencv_ci.py export-env \
            --workspace "$GITHUB_WORKSPACE" \
            --opencv-version "${{ needs.config.outputs.opencv_version }}" \
            --modules-hash "${{ env.OPENCV_MODULES_HASH }}" \
            --build-list "${{ needs.config.outputs.build_list }}" \
            --github-output "$GITHUB_OUTPUT"
      - name: Generate Rust link args
        id: linkargs
        run: |
          python3 .github/tools/opencv_ci.py export-rustflags \
            --link-paths "${{ steps.export.outputs.opencv_link_paths }}" \
            --github-output "$GITHUB_OUTPUT"
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ contains(matrix.args, 'aarch64-apple-darwin') && 'aarch64-apple-darwin' || (contains(matrix.args, 'x86_64-apple-darwin') && 'x86_64-apple-darwin' || '') }}
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          cache-all-crates: true
      - name: Install frontend dependencies
        run: bun install
      - name: Build app
        env:
          OPENCV_LINK_LIBS: ${{ steps.export.outputs.opencv_link_libs }}
          OPENCV_LINK_PATHS: ${{ steps.export.outputs.opencv_link_paths }}
          OPENCV_INCLUDE_PATHS: ${{ steps.export.outputs.opencv_include_paths }}
          RUSTFLAGS: ${{ steps.linkargs.outputs.rustflags }}
        run: bun run tauri build ${{ matrix.args }} -- -vv
      - name: Detect arch
        id: arch
        run: echo "arch=$(uname -m)" >> $GITHUB_OUTPUT
      - name: Upload bundles
        uses: actions/upload-artifact@v4
        with:
          name: tauri-bundles-${{ matrix.platform }}-${{ steps.arch.outputs.arch }}-${{ github.run_id }}
          path: |
            target/**/release/bundle/**/
          if-no-files-found: error
          retention-days: 30